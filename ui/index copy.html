<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <title>RC Car</title>
    <style>
        /* Optional styling for your joystick container */
        #myJoyDiv {
          flex: auto;
          width: 200px;
          height: 200px;
          align-self: center;
        }
    </style>
    <style>
        .textbox,body{font-family:'Open Sans',Helvetica,Sans-Serif}.radio-container,dialog{box-shadow:0 4px 8px rgba(0,0,0,.1)}.slider,body::before{top:0;left:0;right:0;bottom:0}dialog{border:none;border-radius:10px;padding:20px;max-width:600px;width:90%;margin:auto;background-color:transparent}.radio-button:checked,button,input:checked+.slider{background-color:#ffde00}dialog::backdrop{background-color:rgba(0,0,0,.5)}body{margin:0;background-image:url('https://i.pinimg.com/736x/c7/91/85/c791856fe7a09f83b165186f87d88212.jpg');background-repeat:repeat;background-size:auto}body::before{content:"";position:fixed;background-color:rgba(255,255,255,.5);pointer-events:none}.flex-container{display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;gap:18px;z-index:1;overflow-y:auto;padding:20px}.hspread,.hstack{display:flex;gap:20px}@media (max-height:600px){.flex-container{height:auto;padding:10px}}.textbox,button{padding:10px 20px;margin:5px;cursor:pointer}.flex-container>div{width:350px}.hstack{justify-content:center;flex-wrap:wrap}.hspread{justify-content:space-evenly}.textbox{border:none;border-radius:5px}.radio-button{appearance:none;-webkit-appearance:none;-moz-appearance:none;width:20px;height:20px;border:2px solid #ffde00;border-radius:50%;background-color:#fff;cursor:pointer;margin:5px;display:inline-block;vertical-align:middle}.radio-container,.switch-container{align-items:center;background-color:#3336;padding:10px}.radio-button:checked{border-color:#ffde00}.radio-label{margin-left:5px;font-weight:700;color:#f5f5f5;cursor:pointer}.slide-label,.switch-label{margin-left:10px;font-weight:700}.radio-container{display:inline-flex;border-radius:10px}button{border:none;border-radius:5px;color:#333;font-weight:700;box-shadow:0 6px 12px rgba(0,0,0,.25)}button:hover{background-color:#e6c200}button:disabled{background-color:#ccc;color:#666;cursor:not-allowed}.switch-container{display:flex;border-radius:20px}.switch-label{color:#f5f5f5}.switch{position:relative;display:inline-block;width:60px;height:34px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;background-color:#ccc;-webkit-transition:.1s;transition:.1s}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:#fff;-webkit-transition:.1s;transition:.1s}input:focus+.slider{box-shadow:0 0 1px #e6c200}input:checked+.slider:before{-webkit-transform:translateX(26px);-ms-transform:translateX(26px);transform:translateX(26px)}.slider.round{border-radius:34px}.slider.round:before{border-radius:50%}.slidecontainer{display:flex;align-items:center;background-color:#3336;border-radius:20px;padding:10px;width:100%;box-sizing:border-box}.slide-label{color:#f5f5f5;font-family:'Courier New',Courier,monospace}.slidecontainer>input{width:100%;-webkit-appearance:none;appearance:none;height:10px;background:#333;outline:0;opacity:.7;transition:opacity .2s}.slidecontainer>input:hover{opacity:1}.slidecontainer>input::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:25px;height:25px;background:#ffde00;cursor:pointer;border-radius:50%}.slidecontainer>input::-moz-range-thumb{width:25px;height:25px;background:#ffde00;cursor:pointer;border-radius:50%}.card{display:flex;flex-direction:column;align-items:stretch;background-color:#367B2BE0;border-radius:10px;padding:20px;box-shadow:0 6px 12px rgba(0,0,0,.67)}.card h2{color:#f5f5f5;margin:0 0 10px}
    </style>
    <script src="joy.js"></script>
    <link rel="stylesheet" href="style.css">
    <script>
        let throttleDirection=0,throttleLimit=.5,steeringDirection=0,steeringLimit=.5,prevThrottle=0,prevSteering=0;const isLocalDocument="file:"===window.location.protocol||"content:"===window.location.protocol,isMobile=navigator.userAgentData.mobile;let isRequestInProgress=!1;function sendUpdate(){function e(e,t){return Math.round(e/t)*t}let t=Number(e(throttleDirection*throttleLimit,.05).toFixed(2)),o=Number(e(steeringDirection*steeringLimit,.05).toFixed(2));if(t===prevThrottle&&o===prevSteering||isRequestInProgress){console.log("No change or request in progress");return}{isRequestInProgress=!0;let r=new URLSearchParams;o!==prevSteering&&r.append("s",o),t!==prevThrottle&&r.append("t",t),console.log(JSON.stringify(Object.fromEntries(r.entries()))),prevThrottle=t,prevSteering=o;let i;isLocalDocument?i=document.getElementById("urlInput").value:(i=`${window.location.protocol}//${window.location.hostname}`,window.location.port&&(i+=`:${window.location.port}`)),console.log("Current URL:",i);let n=`${i}/?${r.toString()}`,l=new AbortController,s=setTimeout(()=>l.abort(),2e3);fetch(n,{signal:l.signal}).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{console.log(e)}).catch(e=>{"AbortError"===e.name?console.error("Fetch request timed out"):console.error("There has been a problem with your fetch operation:",e)}).finally(()=>{clearTimeout(s),isRequestInProgress=!1,sendUpdate()})}}function updateThrottleLimit(){let e=document.getElementById("throttleSlider"),t=document.getElementById("throttleLimit"),o=e.value;o=o.padStart(3," ").replace(/ /g,"\xa0")+"%",t.innerText=o,throttleLimit=e.value/100}function updateSteeringLimit(){let e=document.getElementById("steeringSlider"),t=document.getElementById("steeringLimit"),o=e.value;o=o.padStart(3," ").replace(/ /g,"\xa0")+"%",t.innerText=o,steeringLimit=e.value/100}function load(){function e(e){let t=this.querySelector('input[type="radio"]');t&&e.target!==t&&t.click()}console.log("isMobile:",isMobile),console.log("isLocalDocument:",isLocalDocument);let t=document.querySelectorAll(".radio-container");function o(e,t){let o=!0;switch(e.key){case"w":throttleDirection=t?1:0;break;case"s":throttleDirection=t?-1:0;break;case"a":steeringDirection=t?-1:0;break;case"d":steeringDirection=t?1:0;break;default:o=!1}o&&sendUpdate()}t.forEach(t=>{t.addEventListener("click",e)}),isMobile?document.querySelectorAll(".desktop").forEach(e=>e.style.display="none"):document.querySelectorAll(".mobile").forEach(e=>e.style.display="none"),isLocalDocument&&(document.getElementById("settingsDialog").showModal(),document.getElementById("urlInput").value=localStorage.getItem("url")),document.addEventListener("keydown",function(e){o(e,!0)}),document.addEventListener("keyup",function(e){o(e,!1)})}function saveUrl(){let e=document.getElementById("urlInput");localStorage.setItem("url",e.value)}function closeDialog(){document.getElementById("settingsDialog").close()}
    </script>
    <script>
        let StickStatus={xPosition:0,yPosition:0,x:0,y:0,cardinalDirection:"C"};var JoyStick=function(t,i,e){var n=void 0===(i=i||{}).title?"joystick":i.title,o=void 0===i.width?0:i.width,c=void 0===i.height?0:i.height,r=void 0===i.internalFillColor?"#00AA00":i.internalFillColor,a=void 0===i.internalLineWidth?2:i.internalLineWidth,d=void 0===i.internalStrokeColor?"#003300":i.internalStrokeColor,$=void 0===i.externalLineWidth?2:i.externalLineWidth,u=void 0===i.externalStrokeColor?"#008000":i.externalStrokeColor,h=void 0===i.autoReturnToCenter||i.autoReturnToCenter;e=e||function(t){};var s=document.getElementById(t);s.style.touchAction="none";var l=document.createElement("canvas");l.id=n,0===o&&(o=s.clientWidth),0===c&&(c=s.clientHeight),l.width=o,l.height=c,s.appendChild(l);var S=l.getContext("2d"),k=0,_=2*Math.PI,g=(l.width-(l.width/2+10))/2,f=g+5,x=g+30,v=l.width/2,C=l.height/2,y=l.width/10,w=-1*y,P=l.height/10,F=-1*P,E=v,L=C;function W(){S.beginPath(),S.arc(v,C,x,0,_,!1),S.lineWidth=$,S.strokeStyle=u,S.stroke()}function m(){S.beginPath(),E<g&&(E=f),E+g>l.width&&(E=l.width-f),L<g&&(L=f),L+g>l.height&&(L=l.height-f),S.arc(E,L,g,0,_,!1);var t=S.createRadialGradient(v,C,5,v,C,200);t.addColorStop(0,r),t.addColorStop(1,d),S.fillStyle=t,S.fill(),S.lineWidth=a,S.strokeStyle=d,S.stroke()}"ontouchstart"in document.documentElement?(l.addEventListener("touchstart",function t(i){k=1,R=i.targetTouches[0].identifier},!1),document.addEventListener("touchmove",function t(i){if(1===k&&i.targetTouches[0].target===l){let n=l.getBoundingClientRect();E=i.targetTouches[0].clientX-n.left,L=i.targetTouches[0].clientY-n.top,S.clearRect(0,0,l.width,l.height),W(),m(),StickStatus.xPosition=E,StickStatus.yPosition=L,StickStatus.x=(100*((E-v)/f)).toFixed(),StickStatus.y=(-(100*((L-C)/f)*1)).toFixed(),StickStatus.cardinalDirection=p(),e(StickStatus)}},!1),document.addEventListener("touchend",function t(i){i.changedTouches[0].identifier===R&&(k=0,h&&(E=v,L=C),S.clearRect(0,0,l.width,l.height),W(),m(),StickStatus.xPosition=E,StickStatus.yPosition=L,StickStatus.x=(100*((E-v)/f)).toFixed(),StickStatus.y=(-(100*((L-C)/f)*1)).toFixed(),StickStatus.cardinalDirection=p(),e(StickStatus))},!1)):(l.addEventListener("mousedown",G,!1),document.addEventListener("mousemove",function t(i){if(1===k){let n=l.getBoundingClientRect();E=i.clientX-n.left,L=i.clientY-n.top,S.clearRect(0,0,l.width,l.height),W(),m(),StickStatus.xPosition=E,StickStatus.yPosition=L,StickStatus.x=(100*((E-v)/f)).toFixed(),StickStatus.y=(-(100*((L-C)/f)*1)).toFixed(),StickStatus.cardinalDirection=p(),e(StickStatus)}},!1),document.addEventListener("mouseup",function t(i){k=0,h&&(E=v,L=C),S.clearRect(0,0,l.width,l.height),W(),m(),StickStatus.xPosition=E,StickStatus.yPosition=L,StickStatus.x=(100*((E-v)/f)).toFixed(),StickStatus.y=(-(100*((L-C)/f)*1)).toFixed(),StickStatus.cardinalDirection=p(),e(StickStatus)},!1)),W(),m();let R=null;function G(t){k=1}function p(){let t="",i=E-v,e=L-C;return e>=F&&e<=P&&(t="C"),e<F&&(t="N"),e>P&&(t="S"),i<w&&("C"===t?t="W":t+="W"),i>y&&("C"===t?t="E":t+="E"),t}this.GetWidth=function(){return l.width},this.GetHeight=function(){return l.height},this.GetPosX=function(){return E},this.GetPosY=function(){return L},this.GetX=function(){return(100*((E-v)/f)).toFixed()},this.GetY=function(){return(-(100*((L-C)/f)*1)).toFixed()},this.GetDir=function(){return p()}};
    </script>
</head>
<body onload="load()">
    <div class="flex-container">
        <dialog id="settingsDialog">
            <div id="urlContainer" class="card">
                <h2>URL</h2>
                <input type="text" id="urlInput" class="textbox" value="" onchange="saveUrl()" />
                <button onclick="closeDialog()">Close</button>
            </div>
        </dialog>

        <div class="card">
            <h2>Throttle Limiter</h2>
            <div class="hstack">
                <div class="slidecontainer">
                    <input type="range" min="0" max="100" value="50" step="5" id="throttleSlider" oninput="updateThrottleLimit()" onchange="sendUpdate()">
                    <span class="slide-label" id="throttleLimit">&nbsp;&nbsp;50%</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Steering Limit</h2>
            <div class="hstack">
                <div class="slidecontainer">
                    <input type="range" min="0" max="100" value="50" step="5" id="steeringSlider" oninput="updateSteeringLimit()" onchange="sendUpdate()">
                    <span class="slide-label" id="steeringLimit">&nbsp;&nbsp;50%</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Joystick</h2>
            <div id="myJoyDiv"></div>
            <script>
                // Instantiate the JoyStick after the DOM is available
                var myJoystick = new JoyStick('myJoyDiv', {
                    title: "myJoystick",
                    autoReturnToCenter: true,
                    internalFillColor: "#FFDE00",    // Change internal (stick) fill color to red
                    internalStrokeColor: "#000000",  // Change internal (stick) border color to black
                    externalStrokeColor: "#000000"   // Change external circle color to blue
                }, function(stickData) {
                    // Assume stickData.x and stickData.y (as provided by joy.js) are in range -100 .. 100.
                    // Normalize to range -1 .. 1:
                    let normX = Number((Math.round((parseFloat(stickData.x) / 100) / 0.05) * 0.05).toFixed(2));
                    let normY = Number((Math.round((parseFloat(stickData.y) / 100) / 0.05) * 0.05).toFixed(2));
                    
                    // Update direction values using these normalized values. For example:
                    steeringDirection = normX;
                    throttleDirection = normY;
                    sendUpdate();
                    //console.log("Joystick normalized position:", { x: normX, y: normY });
                });
            </script>
        </div>
    </div>
</body>
</html>